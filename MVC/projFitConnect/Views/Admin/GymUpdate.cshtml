@{
    ViewData["Title"] = "GymUpdate";
}
@section Styles {
    <style>
        .main {
            width: 92%;
            margin: auto;
        }
    </style>
}
<h1 style="padding-left:64px;margin:15px 0;">修改場館</h1>
<div class="ps-3 main">
    <form method="put" action="https://localhost:7199/api/GymList" enctype="multipart/form-data" id="gymForm">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <h3>請輸入負責人名</h3>
                    <div class="input-group">
                        <span class="input-group-text" id="basic-addon1">負責人姓名</span>
                        <input type="text" class="form-control" id="InputOwner" aria-describedby="basic-addon1" name="Owner">
                    </div>
                </div>

                <div class="mb-3">
                    <h3>請輸入公司名</h3>
                    <div class="input-group">
                        <span class="input-group-text" id="basic-addon1">公司名</span>
                        <input type="text" class="form-control" id="Name" aria-describedby="basic-addon1" name="Name">
                    </div>
                </div>

                <div class="mb-3">
                    <h3>請輸入電話</h3>
                    <div class="input-group">
                        <span class="input-group-text" id="basic-addon1">電話</span>
                        <input type="text" class="form-control" id="GymPhone" aria-describedby="basic-addon1" name="GymPhone">
                    </div>
                </div>
                <div class="mb-3">
                    <h3>上傳場館照片</h3>
                    <input class="form-control form-control-sm" id="GymPhoto" type="file" name="UploadedGymPhoto">
                </div>
                <div class="mb-3">
                    <h3>場館照片</h3>
                    <img src=" data:image /png;base64,${item.gymPhoto}" id="GymPhoto2" class="img-fluid rounded">
                </div>
            </div>

            <div class="col-md-6">
                <div class="mb-3">
                    <h3>請輸入場館名</h3>
                    <div class="input-group">
                        <span class="input-group-text" id="basic-addon1">場館名</span>
                        <input type="text" class="form-control" id="GymName" aria-describedby="basic-addon1" name="GymName">
                    </div>
                </div>

                <div class="mb-3">
                    <h3>營業時間</h3>
                    <div class="input-group mb-3">
                        <select class="form-select" aria-label="Default select example" id="start_time" name="start_time">
                            <option selected disabled>開始時間</option>
                        </select>
                        <select class="form-select" aria-label="Default select example" id="end_time" name="end_time">
                            <option selected disabled>結束時間</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <h3>縣市   地區</h3>
                    <div class="input-group mb-3">
                        <select class="form-select" aria-label="Default select example" id="citys" name="city">
                            
                        </select>
                        <select class="form-select" aria-label="Default select example" id="regions" name="GymRegion">
                            
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <h3>請輸入地址</h3>
                    <div class="input-group">
                        <span class="input-group-text" id="basic-addon1">地址</span>
                        <input type="text" class="form-control" id="GymAddress" aria-describedby="basic-addon1" name="GymAddress">
                    </div>
                </div>

                <div class="mb-3">
                    <h3>請輸入停車場資訊</h3>
                    <div class="input-group">
                        <span class="input-group-text" id="basic-addon1">停車場</span>
                        <input type="text" class="form-control" id="GymPark"  aria-describedby="basic-addon1" name="GymPark">
                    </div>
                </div>

                <div class="mb-3">
                    <h3>請輸入交通資訊</h3>
                    <div class="input-group">
                        <span class="input-group-text" id="basic-addon1">交通</span>
                        <input type="text" class="form-control" id="GymTraffic"  aria-describedby="basic-addon1" name="GymTraffic">
                    </div>
                </div>

                <div class="input-group">
                    <span class="input-group-text">場館簡介</span>
                    <textarea class="form-control" id="GymDescribe" name="GymDescribe"></textarea>
                </div>
                <br />
                <button type="submit" class="btn btn-primary" id="btnsubmit">送出並修改</button>
                <a href="https://localhost:7168/admin/gymreviewlist" class="btn btn-primary" id="btnsubmit">返回列表</a>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        let data = '';
        (async () => {
            const params = new URLSearchParams(window.location.search);
            const gymId = params.get('id');

            if (gymId) {
                try {
                    const response = await fetch(`https://localhost:7199/api/AdminGymlist/${gymId}`);
                    data = await response.json();
                    if (data) {
                        console.log("Fetched data:", data);
                        //資料API讀取
                        const setValue = (elementId, value) => {
                            const element = document.getElementById(elementId);
                            element.value = value || '';
                        };
                        //填入回傳資料
                        setValue('InputOwner', data.owner);
                        setValue('Name', data.name);
                        setValue('GymPhone', data.gymPhone);
                        setValue('GymName', data.gymName);
                        setValue('start_time', data.start_time);
                        setValue('end_time', data.end_time);
                        setValue('citys', data.city);
                        setValue('regions', data.region);
                        setValue('GymAddress', data.gymAddress);
                        setValue('GymPark', data.gymPark);
                        setValue('GymTraffic', data.gymTraffic);

                        const gymDescribeElement = document.getElementById('GymDescribe');
                        gymDescribeElement.value = data.gymDescribe || '';
                        //gymDescribeElement.setAttribute('readonly', true);
                        //如果有圖片則顯示
                        if (data.gymPhoto) {
                            const img = document.getElementById('GymPhoto2');
                            img.src = `data:image/png;base64,${data.gymPhoto}`;
                            img.style.display = 'block';
                        }
                        console.log(data.start_time)
                        console.log('取直結束');
                    }
                } catch (error) {
                    console.error('Error fetching gym data:', error);
                }
            }





            const divResult = document.querySelector('#div1');
            const start = document.getElementById('start_time');
            const end = document.getElementById('end_time');

            // 讀取時間選項
            async function loadData() {
                try {
                    console.log(data);
                    const response = await fetch('https://localhost:7199/api/GymList/time');
                    const data2 = await response.json();
                    let timeOptions = data2.map(item => `<option value="${item.timeName.substring(0, 5)}">${item.timeName.substring(0, 5)}</option>`).join('');

                    start.innerHTML = timeOptions;
                    end.innerHTML = timeOptions;
                    start.value = data.start_time;
                    end.value = data.end_time;
                    console.log(start.value);
                    // 讀取select事件
                    start.addEventListener('change', handleTimeChange);
                    end.addEventListener('change', handleTimeChange);
                } catch (error) {
                    console.error("Error loading time data:", error);
                }
            };

            // 如果開始時間超過結束時間，把結束時間改成開始時間
            async function handleTimeChange() {
                const startTime = parseInt(start.value);
                const endTime = parseInt(end.value);

                if (startTime > endTime) {
                    end.value = start.value;
                }
            };

            // 新增陣列用來記錄縣市地區資料
            let allData = [];
            // 新增陣列用來記錄 regionid
            let regionIdMap = {};
            // 載入縣市
            async function loadCities() {
                const citySelect = document.getElementById('citys');
                try {
                    const response = await fetch("https://localhost:7199/api/Region");
                    allData = await response.json();// 將數據存儲在全局變量中

                    const uniqueCities = new Set();
                    allData.forEach(item => {
                        if (!uniqueCities.has(item.city)) {
                            uniqueCities.add(item.city);
                            const option = document.createElement('option');
                            option.value = item.city;
                            option.textContent = item.city;
                            citySelect.appendChild(option);
                        }
                    });
                    citySelect.value = data.city;
                    await loadRegions();
                } catch (error) {
                    console.error("Error fetching cities data:", error);
                }
            };

            // 載入地區
            async function loadRegions() {
                const regions = document.getElementById('regions');
                const citySelect = document.getElementById('citys');
                const selectedCity = citySelect.value;
                //const selectedRegion = regions.value;

                let regionOptions = '';
                const filteredRegions = allData.filter(item => item.city === selectedCity);

                regionIdMap = {};
                filteredRegions.forEach(item => {
                    regionOptions += `<option value="${item.region}">${item.region}</option>`;
                    regionIdMap[item.region] = item.regionId;
                });
                regions.innerHTML = regionOptions;
            };

            async function init() {
                await loadData();
                await loadCities();

                const citySelect = document.getElementById('citys');
                citySelect.addEventListener('change', async () => {
                    await loadRegions();
                    const selectedRegion = document.getElementById('regions').value;
                    //console.log(selectedRegion);  // 確保選擇的地區被正確印出
                    const regionId = regionIdMap[selectedRegion];
                    //console.log(regionId);  // 如果需要，可以印出對應的 regionId
                });
            }

            init();
        })();
            

    </script>
}
